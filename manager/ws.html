<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>STOMP WebSocket Tester</title>
  <!-- Import Map for StompJS -->
  <script type="importmap">
    {
      "imports": {
        "@stomp/stompjs": "https://ga.jspm.io/npm:@stomp/stompjs@7.0.0/esm6/index.js"
      }
    }
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f7f7f7;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      min-height: 100vh;
    }
    .left-panel, .right-panel {
      box-sizing: border-box;
      padding: 20px;
    }
    .left-panel {
      flex: 0 0 50%;
      max-width: 50%;
      background: #ffffff;
      border-right: 1px solid #ddd;
    }
    .right-panel {
      flex: 1;
      background: #ffffff;
    }
    h2, h3 {
      margin-top: 0;
    }
    .inline-status {
      display: inline-block;
      margin-left: 15px;
      vertical-align: middle;
    }
    .row {
      margin-bottom: 12px;
    }
    .inline-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }
    .inline-row label {
      margin-right: 5px;
      font-weight: bold;
    }
    select, input[type="text"], textarea {
      padding: 6px;
      margin: 2px 0;
      box-sizing: border-box;
    }
    button {
      padding: 6px 12px;
      margin-right: 6px;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .status {
      padding: 6px;
      border: 2px solid #ccc;
      border-radius: 5px;
      display: inline-block;
    }
    .status.connected {
      border-color: green;
      color: green;
    }
    .status.disconnected {
      border-color: red;
      color: red;
    }
    .message-log {
      max-height: calc(100vh - 80px);
      overflow-y: auto;
      background: #f9f9f9;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
    }
    .message-log li {
      margin-bottom: 5px;
    }
    hr {
      margin: 20px 0;
      border: none;
      border-top: 1px solid #e0e0e0;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- LEFT PANEL -->
  <div class="left-panel">
    <!-- Heading + Connection Status -->
    <h2>
      STOMP WebSocket Tester
      <span id="status" class="status disconnected inline-status">Disconnected</span>
    </h2>

    <!-- BASE URL + ENDPOINT (Single Row) -->
    <div class="row inline-row">
      <label for="base-url">Base URL:</label>
      <input type="text" id="base-url" placeholder="wss://example.com" style="flex:1; margin-right:5px;" />
      <label for="endpoints">Endpoint:</label>
      <select id="endpoints" style="width:100px;">
        <option value="/api/v1/mobile/ws">mobile</option>
        <option value="/api/v1/kiosk/ws">kiosk</option>
        <option value="/api/v1/web/ws">web</option>
      </select>
    </div>

    <!-- Handshake Query Params -->
    <h3>Handshake Query Params</h3>
    <div class="row inline-row">
      <label for="x-api-key">X-API-Key:</label>
      <input type="text" id="x-api-key" placeholder="Enter API key" style="flex:1;" />
    </div>
    <div class="row inline-row">
      <label for="x-machine-id">Kiosk UID:</label>
      <input type="text" id="x-machine-id" placeholder="Enter Kiosk ID" style="flex:1;" />
    </div>
    <div class="row inline-row">
      <label for="bearer-token">Bearer:</label>
      <input type="text" id="bearer-token" placeholder="Enter Bearer Token" style="flex:1;" />
    </div>

    <!-- Connect/Disconnect Buttons -->
    <div class="row">
      <button id="connect-btn">Connect</button>
      <button id="disconnect-btn" disabled>Disconnect</button>
    </div>

    <hr/>

    <!-- Subscription (single row: prefix, infix, suffix, subscribe, unsubscribe) -->
    <h3>Subscription</h3>
    <div class="row inline-row">
      <label>Prefix:</label>
      <select id="prefixSelect" title="prefix" style="width:110px; margin-right:5px;"></select>

      <label>Infix:</label>
      <select id="infixSelect" title="infix" style="width:130px; margin-left:5px;"></select>

      <label>Suffix:</label>
      <input type="text" id="topic-suffix" placeholder="/123" style="width:60px; margin-left:5px;"/>

      <button id="subscribe-btn" disabled>Subscribe</button>
      <button id="unsubscribe-btn" disabled>Unsubscribe</button>
    </div>

    <hr/>

    <!-- Send Message Section -->
    <h3>Send a Message</h3>
    <div class="row inline-row">
      <label for="send-destination">Destination:</label>
      <select id="send-destination" style="width:130px;">
        <option value="/app/mobile/">/app/mobile/</option>
        <option value="/app/kiosk/">/app/kiosk/</option>
        <option value="/app/web/">/app/web/</option>
      </select>
      <label>Suffix:</label>
      <input type="text" id="send-suffix" placeholder="/123" style="width:60px; margin-left:5px;"/>
    </div>
    <div class="row">
      <label for="send-body"><strong>Message:</strong></label>
      <textarea id="send-body" rows="3" style="width:100%;" placeholder='{"text":"Hello"}'></textarea>
    </div>
    <div class="row">
      <button id="send-btn" disabled>Send Message</button>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">
    <h3>Received Messages</h3>
    <div class="message-log">
      <ul id="message-log"></ul>
    </div>
  </div>
</div>

<script type="module">
  import { Client } from "@stomp/stompjs";

  let client = null;
  let subscriptions = {};

  // ======== DOM ELEMENTS ========
  const statusDiv        = document.getElementById("status");

  const baseUrlInput     = document.getElementById("base-url");
  const endpointDropdown = document.getElementById("endpoints");
  const connectButton    = document.getElementById("connect-btn");
  const disconnectButton = document.getElementById("disconnect-btn");

  const xApiKeyInput     = document.getElementById("x-api-key");
  const xMachineIdInput  = document.getElementById("x-machine-id");
  const bearerTokenInput = document.getElementById("bearer-token");

  // Subscription controls
  const prefixSelect     = document.getElementById("prefixSelect");
  const infixSelect      = document.getElementById("infixSelect");
  const topicSuffixInput = document.getElementById("topic-suffix");
  const subscribeButton  = document.getElementById("subscribe-btn");
  const unsubscribeButton= document.getElementById("unsubscribe-btn");

  // Send message
  const sendDestination  = document.getElementById("send-destination");
  const sendSuffixInput  = document.getElementById("send-suffix");
  const sendBody         = document.getElementById("send-body");
  const sendButton       = document.getElementById("send-btn");

  const messageLog       = document.getElementById("message-log");

  // ======== LOCAL STORAGE ========
  window.onload = () => {
    baseUrlInput.value     = localStorage.getItem("base-url")     || "";
    xApiKeyInput.value     = localStorage.getItem("x-api-key")     || "";
    xMachineIdInput.value  = localStorage.getItem("x-machine-id")  || "";
    bearerTokenInput.value = localStorage.getItem("bearer-token")  || "";

    if (baseUrlInput.value === "") {
      const protocol = window.location.protocol === "http:" ? "ws:" : "wss:";
      const hostname = window.location.hostname;
      const port     = window.location.port ? ":" + window.location.port : "";
      baseUrlInput.value = protocol + "//" + hostname + port;
    }
  };
  const saveToLocalStorage = (key, value) => localStorage.setItem(key, value);

  baseUrlInput.addEventListener("input",    () => saveToLocalStorage("base-url",     baseUrlInput.value));
  xApiKeyInput.addEventListener("input",    () => saveToLocalStorage("x-api-key",     xApiKeyInput.value));
  xMachineIdInput.addEventListener("input", () => saveToLocalStorage("x-machine-id",  xMachineIdInput.value));
  bearerTokenInput.addEventListener("input",() => saveToLocalStorage("bearer-token",  bearerTokenInput.value));

  // ======== DYNAMIC TOPICS (PREFIX -> Infix Array) ========
  const dynamicTopics = {
    "/topic/public/": ["bookingsAllUpdates", "bookingsUpdatesByCategory/", "bookingsUpdatesByLibrary/", "bookingsUpdatesByFloor/", "bookingsUpdatesByRoom/", "bookingsUpdatesByDeskRoom/", "bookingsUpdatesByDeskSeat/"],
    "/topic/mobile/": [],
    "/topic/kiosk/":  [],
    "/topic/web/":    ["public", "userData/"],
    "/user/queue/mobile/":  ["myBookings", "myNotifications", "reply"],
    "/user/queue/web/":     ["test"],
    "/user/queue/kiosk/":   ["configurationChanges","test"],
  };

  // Populate prefix dropdown
  const populatePrefixDropdown = () => {
    prefixSelect.innerHTML = "";
    Object.keys(dynamicTopics).forEach((prefix) => {
      const option = document.createElement("option");
      option.value = prefix;
      option.textContent = prefix;
      prefixSelect.appendChild(option);
    });
  };

  // Populate infix dropdown based on selected prefix
  const populateInfixDropdown = () => {
    infixSelect.innerHTML = "";
    const selectedPrefix = prefixSelect.value;
    const infixes = dynamicTopics[selectedPrefix] || [];
    infixes.forEach((inf) => {
      const option = document.createElement("option");
      option.value = inf;
      option.textContent = inf;
      infixSelect.appendChild(option);
    });
  };

  const SubUnSubButtonShowHide = () => {

    const prefix = prefixSelect.value;
    const infix  = infixSelect.value;
    const suffix = topicSuffixInput.value.trim(); // e.g. "/123"

    const fullTopic = prefix + infix + suffix;
    if (subscriptions[fullTopic]) {
      subscribeButton.style.display = "none";
      unsubscribeButton.style.display = "block";
    } else {
      subscribeButton.style.display = "block";
      unsubscribeButton.style.display = "none";
    }

  }

  // Initial load
  populatePrefixDropdown();
  populateInfixDropdown();

  prefixSelect.addEventListener("change", () => {
    populateInfixDropdown();
    SubUnSubButtonShowHide();
  });

  infixSelect.addEventListener("change", () => {
    SubUnSubButtonShowHide();
  });

  topicSuffixInput.addEventListener("keyup", () => {
    SubUnSubButtonShowHide();
  });

  // ======== UI HELPERS ========
  const updateStatus = (msg, connected) => {
    statusDiv.textContent = msg;
    if (connected) {
      statusDiv.className = "status connected inline-status";
      // Enable subscription/send buttons
      subscribeButton.disabled = false;
      unsubscribeButton.disabled = false;
      sendButton.disabled = false;
    } else {
      statusDiv.className = "status disconnected inline-status";
      // Disable subscription/send buttons
      subscribeButton.disabled = true;
      unsubscribeButton.disabled = true;
      sendButton.disabled = true;
    }
  };

  const logMessage = (message) => {
    const li = document.createElement("li");
    li.textContent = message;
    messageLog.appendChild(li);
    // Auto-scroll to bottom
    messageLog.scrollTop = messageLog.scrollHeight;
  };

  // ======== CONNECTION HANDLERS ========
  connectButton.addEventListener("click", () => {
    const baseUrl     = baseUrlInput.value.trim();
    const endpoint    = endpointDropdown.value;
    const xApiKey     = xApiKeyInput.value.trim();
    const xMachineId  = xMachineIdInput.value.trim();
    const bearerToken = bearerTokenInput.value.trim();

    const finalBrokerURL = 
      `${baseUrl}${endpoint}?apiKey=${xApiKey}&kioskUID=${xMachineId}&authorization=${encodeURIComponent("Bearer " + bearerToken)}`;

    client = new Client({
      brokerURL: finalBrokerURL,
      debug: (str) => console.log(str),
      onConnect: () => {
        updateStatus("Connected", true);
        disconnectButton.disabled = false;
        connectButton.disabled    = true;
        logMessage("Connected to " + finalBrokerURL);
        SubUnSubButtonShowHide();

        // for each subscriptions
        for (var fullTopic in subscriptions) {
          subscriptions[fullTopic] = client.subscribe(fullTopic, (message) => {
            logMessage(`Received from ${fullTopic}: ${message.body}`);
          });
          logMessage(`Subscribed to ${fullTopic}`);
        }
      },
      onDisconnect: () => {
        updateStatus("Disconnected", false);
        connectButton.disabled    = false;
        disconnectButton.disabled = true;
        logMessage("Disconnected from server");
      },
      onStompError: (frame) => {
        logMessage(`STOMP Error: ${frame.headers["message"]}`);
        updateStatus("Error occurred", false);
      },
      onWebSocketClose: () => {
        updateStatus("Socket Closed", false);
        connectButton.disabled    = false;
        disconnectButton.disabled = true;
        logMessage("WebSocket closed");
      }
    });
    client.activate();
  });

  disconnectButton.addEventListener("click", () => {
    if (client) {
      client.deactivate();
      updateStatus("Disconnected", false);
      connectButton.disabled    = false;
      disconnectButton.disabled = true;
      logMessage("Disconnected manually");
    }
  });

  // ======== SUBSCRIBE/UNSUBSCRIBE ========
  subscribeButton.addEventListener("click", () => {
    if (!client || !client.connected) {
      alert("Please connect first!");
      return;
    }
    const prefix = prefixSelect.value;
    const infix  = infixSelect.value;
    const suffix = topicSuffixInput.value.trim(); // e.g. "/123"

    const fullTopic = prefix + infix + suffix;
    if (subscriptions[fullTopic]) {
      alert(`Already subscribed to: ${fullTopic}`);
      return;
    }
    // Subscribe
    subscriptions[fullTopic] = client.subscribe(fullTopic, (message) => {
      logMessage(`Received from ${fullTopic}: ${message.body}`);
    });
    logMessage(`Subscribed to ${fullTopic}`);
    SubUnSubButtonShowHide();
  });

  unsubscribeButton.addEventListener("click", () => {
    if (!client || !client.connected) {
      return;
    }
    const prefix = prefixSelect.value;
    const infix  = infixSelect.value;
    const suffix = topicSuffixInput.value.trim();
    const fullTopic = prefix + infix + suffix;

    if (subscriptions[fullTopic]) {
      subscriptions[fullTopic].unsubscribe();
      delete subscriptions[fullTopic];
      logMessage(`Unsubscribed from ${fullTopic}`);
    } else {
      alert(`Not subscribed to ${fullTopic}`);
    }
    SubUnSubButtonShowHide();
  });

  // ======== SEND MESSAGE ========
  sendButton.addEventListener("click", () => {
    if (!client || !client.connected) {
      alert("Please connect first!");
      return;
    }
    const destinationPrefix = sendDestination.value; // e.g. "/app/mobile/"
    const suffix            = sendSuffixInput.value.trim(); // e.g. "/123"
    const finalDestination  = destinationPrefix + suffix;
    const body              = sendBody.value.trim();

    if (!finalDestination || !body) {
      alert("Please provide both Destination and Message!");
      return;
    }

    try {
      client.publish({
        destination: finalDestination,
        body: body,
        headers: {}
      });
      logMessage(`Sent to ${finalDestination}: ${body}`);
    } catch (e) {
      logMessage(`Error sending message: ${e.message}`);
    }
  });
</script>
</body>
</html>
